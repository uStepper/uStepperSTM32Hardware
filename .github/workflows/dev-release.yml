name: Dev Release

on:
  push:
    branches: [ feature-CI/CD ]

permissions:
  contents: write

jobs:
  dev-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Maybe bump VERSION (patch) if equals latest stable
        run: |
          bash .github/workflows/scripts/bump_version_if_equal_latest_stable.sh VERSION

      - name: Commit VERSION change (if any)
        run: |
      - name: Commit VERSION change (if any)
        run: |
          git add VERSION

          # Tjek kun om der er staged ændringer (altså VERSION)
          if git diff --cached --quiet; then
            echo "No VERSION change to commit."
            exit 0
          fi

          git commit -m "chore: bump VERSION for dev cycle [skip ci]"
          git push origin HEAD:${GITHUB_REF_NAME}

      - name: Read base version
        id: ver
        run: |
          base="$(cat VERSION | tr -d ' \n\r\t')"
          echo "base=$base" >> "$GITHUB_OUTPUT"
          echo "dev=${base}-dev.${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "tag=v${base}-dev.${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

      # ---- BUILD STEP (tilpas til dit build) ----
      - name: Build Arduino package bundle (tar.bz2)
        run: |
          bash .github/workflows/scripts/build_tar.sh

       #(Valgfrit) Opdatér develop package index / package.json her
      - name: Update package.json for develop
        run: |
          bash .github/workflows/scripts/update_package_json.sh

      #- name: Create GitHub prerelease (dev)
      #  uses: softprops/action-gh-release@v2
      #  with:
      #    tag_name: ${{ steps.ver.outputs.tag }}
      #    name: ${{ steps.ver.outputs.tag }}
      #    prerelease: true
      #    generate_release_notes: true
      #    files: |
      #      ${{ env.TARBALL }}